<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Supermarket</title>
    <style>
        /* Center the buttons on the page */
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 50px;
        }

        /* Style for buttons */
        button {
            width: 100px; /* Set button width */
            height: 30px; /* Set button height */
            font-size: 14px; /* Set font size */
            margin: 10px 0; /* Space between buttons */
            cursor: pointer; /* Change cursor on hover */
        }

        /* Optional: Add some hover effects */
        button:hover {
            background-color: #f0f0f0;
        }

        /* Optional: Different color for each button */
        #scanToSellBtn {
            width: 300px; /* Set button width */
            height: 80px; /* Set button height */
            font-size: 25px; /* Set font size */
            margin: 10px 0; /* Space between buttons */
            cursor: pointer; /* Change cursor on hover */
            background-color: #4CAF50; /* Green background */
            color: white;
        }

        /* Style for Scan to Return Button (smaller size) */
        #scanToReturnBtn {
            width: 100px; /* Smaller width */
            height: 40px; /* Smaller height */
            font-size: 14px; /* Smaller font size */
            margin-top: 40px; /* Extra space above */
            cursor: pointer;
            background-color: #f44336; /* Red background */
            color: white;
        }

        /* Style for the text */
        .break-free-text {
            font-size: 100px;
            margin: 50px 0; /* Space around the text */
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
<h1>琴溪洗马桥加油站收银系统</h1>
<a href="/accumulate">统计</a>
<a href="/accum_logs">查看历史统计</a>
<form action="/add" method="POST">
    <input type="text" name="name" placeholder="商品名称" required>
    <input type="text" name="price" placeholder="商品价格" required>
    <input type="number" name="quantity" placeholder="数量" required>
    <input type="text" name="barcode" placeholder="条形码数字" required>
    <button type="submit">添加商品</button>
</form>

<button id="scanToSellBtn">销售扫码</button>
<h2>商品列表</h2>
<table>
    <tr>
        <th>商品</th>
        <th>价格</th>
        <th>数量</th>
        <th>条形码</th>
    </tr>
    {% for product in products %}
    <tr>
        <td>{{ product[1] }}</td>
        <td>{{ product[2] }}</td>
        <td>{{ product[3] }}</td>
        <td>{{ product[4] }}</td>
    </tr>
    {% endfor %}
</table>


<p class="break-free-text">=======================</p>

<!-- Scan to Return Button -->
<button id="scanToReturnBtn">退货扫码</button>

<!-- Modal for Scan to Sell/Return -->
<div id="scanModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Scan to Sell</h2>
        <p>Enter Barcode:</p>
        <input type="text" id="barcodeInput" placeholder="Enter barcode">
    </div>
</div>


<script>
    var modal = document.getElementById("scanModal");
    var btnSell = document.getElementById("scanToSellBtn");
    var btnReturn = document.getElementById("scanToReturnBtn");
    var span = document.getElementsByClassName("close")[0];
    var barcodeInput = document.getElementById("barcodeInput");
    var modalTitle = document.getElementById("modalTitle");
    var currentMode = "sell";  // Default mode

    // Show modal when "Scan to Sell" is clicked
    btnSell.onclick = function () {
        modalTitle.textContent = "Scan to Sell";
        modal.style.display = "block";
        barcodeInput.focus();
        currentMode = "sell";
    }

    // Show modal when "Scan to Return" is clicked
    btnReturn.onclick = function () {
        modalTitle.textContent = "Scan to Return";
        modal.style.display = "block";
        barcodeInput.focus();
        currentMode = "return";
    }

    // Close modal when "X" is clicked
    span.onclick = function () {
        modal.style.display = "none";
    }

    // Handle "Enter" key press in the input field
    barcodeInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            let barcode = barcodeInput.value;
            if (barcode) {
                let endpoint = currentMode === "sell" ? '/scan-sell' : '/scan-return';
                // Send barcode to Flask backend via AJAX (fetch)
                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        barcode: barcode
                    })
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                        } else {
                            alert("Error: " + data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));

                barcodeInput.value = "";  // Clear input for next entry
                barcodeInput.focus();     // Refocus on input box
            }
        }
    });
</script>

<h2>Product Inventory</h2>

<!-- Example Product Table -->
<table id="productTable">
    <tr>
        <th>Product Name</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Barcode</th>
    </tr>
    <tr>
        <td>Product A</td>
        <td>10.00</td>
        <td>5</td>
        <td>12345</td>
    </tr>
    <tr>
        <td>Product B</td>
        <td>20.00</td>
        <td>3</td>
        <td>67890</td>
    </tr>
    <tr>
        <td>Product C</td>
        <td>15.00</td>
        <td>7</td>
        <td>11223</td>
    </tr>
</table>

<br>

<!-- Buttons -->
<button id="saveInfoBtn">累积当前库存</button>
<button id="viewInfoBtn">查看上次库存</button>
<button id="viewLogBtn">查看历史库存</button>

<!-- Div to display saved information -->
<div id="savedInfo" style="display: none;">
    <h3>Saved Information</h3>
    <p id="savedTime"></p>
    <p id="savedStockValue"></p>
    <table id="savedTable"></table>
</div>

<!-- Div to display log information -->
<div id="logInfo" style="display: none;">
    <h3>Action Log</h3>
    <ul id="logList"></ul>
</div>

<form action="/update-product" method="POST">
    <label for="barcode">Barcode:</label><br>
    <input type="text" id="barcode" name="barcode" required><br><br>

    <label for="name">Product Name:</label><br>
    <input type="text" id="name" name="name" required><br><br>

    <label for="price">Price:</label><br>
    <input type="number" id="price" name="price" step="0.01" required><br><br>

    <label for="quantity">Quantity:</label><br>
    <input type="number" id="quantity" name="quantity" required><br><br>

    <label for="password">Enter Password:</label><br>
    <input type="password" id="password" name="password" required><br><br>

    <input type="submit" value="更新货品信息">
</form>

<script>
    let log = [];

    // Function to calculate total stock value and save information
    function saveStockInformation() {
        const table = document.getElementById('productTable');
        let totalStockValue = 0;

        // Loop through table rows (skip header)
        for (let i = 1; i < table.rows.length; i++) {
            const price = parseFloat(table.rows[i].cells[1].innerText); // Price
            const quantity = parseInt(table.rows[i].cells[2].innerText); // Quantity
            totalStockValue += price * quantity; // Accumulate stock value
        }

        // Get current timestamp
        const now = new Date();
        const timestamp = now.toLocaleString();

        // Get entire table as HTML string (excluding the save and view buttons)
        const tableHTML = table.outerHTML;

        // Save information in localStorage (for this example)
        const savedData = {
            timestamp: timestamp,
            totalStockValue: totalStockValue,
            tableHTML: tableHTML
        };

        // Save the data in localStorage
        localStorage.setItem('savedStockInfo', JSON.stringify(savedData));

        // Add to log
        log.push({
            timestamp: timestamp,
            totalStockValue: totalStockValue,
            tableHTML: tableHTML
        });

        alert('Stock information saved and logged!');
    }

    // Function to display the saved stock information
    function displaySavedInformation() {
        const savedData = JSON.parse(localStorage.getItem('savedStockInfo'));

        if (savedData) {
            document.getElementById('savedTime').innerText = `累积时间: ${savedData.timestamp}`;
            document.getElementById('savedStockValue').innerText = `库存总价值: ￥${savedData.totalStockValue.toFixed(2)}`;
            document.getElementById('savedTable').innerHTML = savedData.tableHTML; // Display saved table
            document.getElementById('savedInfo').style.display = 'block'; // Show the saved info section
        } else {
            alert('No saved information available!');
        }
    }

    // Function to display the log information
    function displayLog() {
        const logList = document.getElementById('logList');
        logList.innerHTML = ''; // Clear previous log

        if (log.length > 0) {
            log.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>Time:</strong> ${entry.timestamp}, <strong>Total Stock Value:</strong> $${entry.totalStockValue.toFixed(2)}`;
                logList.appendChild(listItem);
            });
            document.getElementById('logInfo').style.display = 'block'; // Show the log info section
        } else {
            alert('No log entries available!');
        }
    }

    // Attach event listeners to buttons
    document.getElementById('saveInfoBtn').addEventListener('click', saveStockInformation);
    document.getElementById('viewInfoBtn').addEventListener('click', displaySavedInformation);
    document.getElementById('viewLogBtn').addEventListener('click', displayLog);
</script>

<style>
    /* Modal styles */
    body {
        font-family: Arial, sans-serif;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    table, th, td {
        border: 1px solid black;
    }

    th, td {
        padding: 8px;
        text-align: left;
    }

    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        background-color: rgba(0, 0, 0, 0.5); /* Black with opacity */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
<a href="/logs">View Logs</a>
<a href="/accumulate">统计</a>
<a href="/accum_logs">查看历史统计</a>
</body>
</html>
